<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>ref - Csound Plugins</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../css/syntax-highlighting.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "ref";
    var mkdocs_page_input_path = "opcodes/ref.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Csound Plugins</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../index.html">Csound Plugins</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Contributing.html">Contributing</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../Installation.html">Installation</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Opcodes</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="accum.html">accum</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="atstop.html">atstop</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="bisect.html">bisect</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="channelStateRecall.html">channelStateRecall</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="channelStateSave.html">channelStateSave</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="crackle.html">crackle</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="defer.html">defer</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="deref.html">deref</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_del.html">dict_del</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_dump.html">dict_dump</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_exists.html">dict_exists</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_free.html">dict_free</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_get.html">dict_get</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_geti.html">dict_geti</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_iter.html">dict_iter</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_loadstr.html">dict_loadstr</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_new.html">dict_new</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_print.html">dict_print</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_query.html">dict_query</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_set.html">dict_set</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="dict_size.html">dict_size</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="diode_ringmod.html">diode_ringmod</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="extendarray.html">extendarray</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="fileexists.html">file_exists</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="findFileInPath.html">findFileInPath</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="findarray.html">findarray</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="frac2int.html">frac2int</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ftfill.html">ftfill</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ftfind.html">ftfind</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ftnew.html">ftnew</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ftsetparams.html">ftsetparams</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="getEnvVar.html">getEnvVar</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="initerror.html">initerror</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="interp1d.html">interp1d</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="jsfx.html">jsfx</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="jsfx_getslider.html">jsfx_setslider</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="jsfx_new.html">jsfx_new</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="jsfx_play.html">jsfx_play</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="jsfx_setslider.html">jsfx_setslider</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="lfnoise.html">lfnoise</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="linenv.html">linenv</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="loadmtx.html">loadmtx</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="memview.html">memview</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathAbsolute.html">pathAbsolute</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathIsAbsolute.html">pathIsAbsolute</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathJoin.html">pathJoin</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathNative.html">pathNative</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathSplit.html">pathSplit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathSplitExt.html">pathSplitExt</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathSplitExtk.html">pathSplitExtk</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pathSplitk.html">pathSplitk</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="perlin3.html">perlin3</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="poly.html">poly</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="poly0.html">poly0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="polyseq.html">polyseq</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_at.html">pool_at</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_capacity.html">pool_capacity</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_gen.html">pool_gen</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_isfull.html">pool_isfull</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_new.html">pool_new</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_pop.html">pool_pop</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_push.html">pool_push</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pool_size.html">pool_size</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pread.html">pread</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="pwrite.html">pwrite</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="ramptrig.html">ramptrig</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="ref.html">ref</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#abstract">Abstract</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#description">Description</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#syntax">Syntax</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#arguments">Arguments</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#output">Output</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#execution-time">Execution Time</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#see-also">See also</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#credits">Credits</a>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="refvalid.html">refvalid</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="schmitt.html">schmitt</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="scriptDir.html">scriptDir</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="sderef.html">sderef</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="setslice.html">setslice</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="sfreadmeta.html">sfreadmeta</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="sigmdrive.html">sigmdrive</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="sref.html">sref</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="standardchaos.html">standardchaos</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="strsplit.html">strsplit</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="sysPlatform.html">sysPlatform</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="throwerror.html">throwerror</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="trigExpseg.html">trigExpseg</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="trigLinseg.html">trigLinseg</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="tubeharmonics.html">tubeharmonics</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="uniqinstance.html">uniqinstance</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="zeroarray.html">zeroarray</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Csound Plugins</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Opcodes &raquo;</li>
        
      
    
    <li>ref</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="ref">ref</h1>
<h2 id="abstract">Abstract</h2>
<p>Get a reference to a variable</p>
<h2 id="description">Description</h2>
<p><code>ref</code> and <code>deref</code> implement a mechanism to pass a reference to an array,
allowing to share it across instruments, opcodes, etc. Refs are reference counted and
deallocate themselves when out of scope and not being used by any
object. It makes it possible to pass arrays by reference to user defined
opcodes, allowing to modify an array in place, skip copying memory, etc.</p>
<div class="codehilite"><pre><span></span><code><span class="kt">i</span><span class="n">X</span><span class="p">[]</span> <span class="nb">fillarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span>
<span class="kt">i</span><span class="n">ref</span>  <span class="n">ref</span> <span class="kt">i</span><span class="n">X</span>
<span class="kt">i</span><span class="n">Y</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
</code></pre></div>

<p>In the case above, <code>iY</code> shares the same memory as <code>iX</code> and any modification in
one array will be visible in the other. </p>
<h2 id="syntax">Syntax</h2>
<div class="codehilite"><pre><span></span><code><span class="kt">i</span><span class="n">ref</span> <span class="n">ref</span> <span class="n">xArray</span><span class="p">,</span> <span class="p">[</span><span class="kt">i</span><span class="n">extrarefs</span><span class="o">=</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>

<h2 id="arguments">Arguments</h2>
<ul>
<li><strong>xArray</strong>: the array to be referenced</li>
<li><strong>iextrarefs</strong>: use this for the <em>niche</em> case where a reference is passed to an
  event scheduled at a point in time later that the end of the current event.
  Without this, the ref would go out of scope before the <code>deref</code> takes place. 
  Any extra ref must be matched with an extra deref (<code>kArr[] deref iref, 1</code>)</li>
</ul>
<h2 id="output">Output</h2>
<ul>
<li><strong>iref</strong>: an integer identifying the reference handle.</li>
</ul>
<h2 id="execution-time">Execution Time</h2>
<ul>
<li>Init</li>
</ul>
<h2 id="examples">Examples</h2>
<div class="codehilite"><pre><span></span><code><span class="o">&lt;</span><span class="n">CsoundSynthesizer</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">CsOptions</span><span class="o">&gt;</span>
<span class="o">--</span><span class="n">nosound</span>
<span class="o">&lt;/</span><span class="n">CsOptions</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">CsInstruments</span><span class="o">&gt;</span>

<span class="c1">;; Example file for ref - deref</span>

<span class="vg">sr</span>     <span class="o">=</span> <span class="mi">44100</span>
<span class="vg">ksmps</span>  <span class="o">=</span> <span class="mi">64</span>
<span class="vg">nchnls</span> <span class="o">=</span> <span class="mi">2</span>
<span class="vg">0dbfs</span>  <span class="o">=</span> <span class="mi">1</span>

<span class="kt">gi</span><span class="n">A</span><span class="p">[]</span> <span class="nb">fillarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">3000</span>

<span class="c1">; Example 1: take a ref from an array, deref it to create a second view of it </span>
<span class="kd">instr</span> <span class="nf">1</span>
  <span class="c1">; a source array</span>
  <span class="kt">i</span><span class="n">X</span><span class="p">[]</span> <span class="nb">fillarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span>

  <span class="c1">; create a ref of iXs, return the index </span>
  <span class="kt">i</span><span class="n">ref</span> <span class="n">ref</span> <span class="kt">i</span><span class="n">X</span>
  <span class="c1">; now iYs points to iXs</span>
  <span class="kt">i</span><span class="n">Y</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
  <span class="nb">printarray</span> <span class="kt">i</span><span class="n">Y</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;instrument 1, iY&quot;</span>


  <span class="kt">i</span><span class="n">Z</span><span class="p">[]</span> <span class="nb">fillarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span>

  <span class="c1">; create a ref, pass it to instr. 2</span>
  <span class="nb">schedule</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Z</span><span class="p">)</span>

  <span class="c1">; create another ref of iZ. In this case the event is scheduled</span>
  <span class="c1">; in the future, so the source will not exist anymore when instr. 2</span>
  <span class="c1">; is scheduled. This should fail.</span>
  <span class="nb">schedule</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Z</span><span class="p">)</span>

  <span class="nb">turnoff</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">2</span>
  <span class="kt">i</span><span class="n">ref</span> <span class="o">=</span> <span class="vi">p4</span>
  <span class="k">if</span> <span class="n">refvalid</span><span class="p">(</span><span class="kt">i</span><span class="n">ref</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span>
    <span class="kt">i</span><span class="n">Zs</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
    <span class="nb">printarray</span> <span class="kt">i</span><span class="n">Zs</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;p1=2, iZs&quot;</span>
  <span class="k">else</span>
    <span class="nb">prints</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    The reference has become invalid</span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="k">endif</span>
  <span class="nb">turnoff</span>
<span class="kd">endin</span>

<span class="c1">;; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

<span class="c1">; Example 2: extra references to keep array alive</span>
<span class="kd">instr</span> <span class="nf">3</span>
  <span class="c1">; create a source array</span>
  <span class="kt">k</span><span class="n">Xs</span><span class="p">[]</span> <span class="nb">fillarray</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span>

  <span class="c1">; In order to bridge the time gap between the end of life of the source</span>
  <span class="c1">; of a ref and the scheduled event where a deref is taken, it is possible</span>
  <span class="c1">; to create a forward reference, a &quot;promise&quot; that one deref has been scheduled</span>
  <span class="c1">; in the future.</span>

  <span class="c1">; short lived event, ends before this event</span>
  <span class="nb">schedule</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">ref</span><span class="p">(</span><span class="kt">k</span><span class="n">Xs</span><span class="p">),</span> <span class="mi">0</span>

  <span class="c1">; starts before we end, but survives us</span>
  <span class="nb">schedule</span> <span class="mi">4</span><span class="p">,</span> <span class="vi">p3</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">ref</span><span class="p">(</span><span class="kt">k</span><span class="n">Xs</span><span class="p">),</span> <span class="mi">0</span>

  <span class="c1">; starts after we end, we need an extra reference </span>
  <span class="nb">schedule</span> <span class="mi">4</span><span class="p">,</span> <span class="vi">p3</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">ref</span><span class="p">(</span><span class="kt">k</span><span class="n">Xs</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span>

  <span class="n">defer</span> <span class="s">&quot;prints&quot;</span><span class="p">,</span> <span class="s">&quot;  --- instr. 3 finished --- </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">4</span>
  <span class="nb">prints</span> <span class="s">&quot;instr. 4</span><span class="se">\n</span><span class="s">   &quot;</span>
  <span class="kt">k</span><span class="n">View</span><span class="p">[]</span> <span class="n">deref</span> <span class="vi">p4</span><span class="p">,</span> <span class="vi">p5</span>
  <span class="nb">printarray</span> <span class="kt">k</span><span class="n">View</span>
  <span class="n">defer</span> <span class="s">&quot;prints&quot;</span><span class="p">,</span> <span class="s">&quot; --- instr. 4 finished --- </span><span class="se">\n</span><span class="s">&quot;</span>
  <span class="c1">; At deinition time the memory of the `iView` array is marked as deallocated.</span>
  <span class="c1">; The handle (a global structure created by the `ref` opcode) which owns the memory,</span>
  <span class="c1">; is signaled that no other clients of this data are alive. It deallocates the</span>
  <span class="c1">; original memory and frees itself</span>
<span class="kd">endin</span>

  <span class="c1">;; ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>

  <span class="c1">; test: multiple derefs</span>
<span class="kd">instr</span> <span class="nf">5</span>
  <span class="kt">i</span><span class="n">Xs</span><span class="p">[]</span> <span class="nb">fillarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">9</span>
  <span class="kt">i</span><span class="n">ref</span> <span class="n">ref</span> <span class="kt">i</span><span class="n">Xs</span>

  <span class="kt">i</span><span class="n">Ys</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
  <span class="kt">i</span><span class="n">Zs</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
  <span class="nb">printarray</span> <span class="kt">i</span><span class="n">Ys</span>
  <span class="nb">printarray</span> <span class="kt">i</span><span class="n">Zs</span>
  <span class="kt">i</span><span class="n">Xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
  <span class="nb">printarray</span> <span class="kt">i</span><span class="n">Zs</span>
  <span class="nb">turnoff</span>
<span class="kd">endin</span>

<span class="c1">; test performance of pass-by-value vs pass-by-reference</span>
<span class="kd">opcode</span> <span class="nf">arrayadd</span><span class="p">,</span> <span class="kt">i[]</span><span class="p">,</span> <span class="kt">i[]i</span>
  <span class="c1">; pass by value in and out</span>
  <span class="kt">i</span><span class="n">In</span><span class="p">[],</span> <span class="kt">i</span><span class="n">x</span> <span class="nb">xin</span>
  <span class="kt">i</span><span class="n">Out</span><span class="p">[]</span> <span class="o">=</span> <span class="kt">i</span><span class="n">In</span> <span class="o">+</span> <span class="kt">i</span><span class="n">x</span>
  <span class="nb">xout</span> <span class="kt">i</span><span class="n">Out</span>
<span class="kd">endop</span>

<span class="kd">opcode</span> <span class="nf">arrayaddref</span><span class="p">,</span> <span class="kt">i[]</span><span class="p">,</span> <span class="kt">ii</span>
  <span class="c1">; pass by ref in, by value out</span>
  <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="kt">i</span><span class="n">x</span> <span class="nb">xin</span>
  <span class="kt">i</span><span class="n">In</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
  <span class="kt">i</span><span class="n">Out</span><span class="p">[]</span> <span class="o">=</span> <span class="kt">i</span><span class="n">In</span> <span class="o">+</span> <span class="kt">i</span><span class="n">x</span>
  <span class="nb">xout</span> <span class="kt">i</span><span class="n">Out</span>
<span class="kd">endop</span>

<span class="kd">opcode</span> <span class="nf">arrayadd_inplace</span><span class="p">,</span> <span class="kt">0</span><span class="p">,</span> <span class="kt">ii</span>
  <span class="c1">; in place </span>
  <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="kt">i</span><span class="n">x</span> <span class="nb">xin</span>
  <span class="kt">i</span><span class="n">In</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">ref</span>
  <span class="kt">i</span><span class="n">In</span> <span class="o">+=</span> <span class="kt">i</span><span class="n">x</span>
<span class="kd">endop</span>

<span class="kd">opcode</span> <span class="nf">arrayadd_byref_inout</span><span class="p">,</span> <span class="kt">0</span><span class="p">,</span> <span class="kt">iii</span>
  <span class="c1">; pass by ref in and out</span>
  <span class="kt">i</span><span class="n">refin</span><span class="p">,</span> <span class="kt">i</span><span class="n">refout</span><span class="p">,</span> <span class="kt">i</span><span class="n">x</span> <span class="nb">xin</span>
  <span class="kt">i</span><span class="n">In</span><span class="p">[]</span>  <span class="n">deref</span> <span class="kt">i</span><span class="n">refin</span>
  <span class="kt">i</span><span class="n">Out</span><span class="p">[]</span> <span class="n">deref</span> <span class="kt">i</span><span class="n">refout</span>
  <span class="k">if</span> <span class="nb">lenarray</span><span class="p">(</span><span class="kt">i</span><span class="n">Out</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">lenarray</span><span class="p">(</span><span class="kt">i</span><span class="n">In</span><span class="p">)</span> <span class="k">then</span>
    <span class="kt">i</span><span class="n">Out</span> <span class="o">=</span> <span class="kt">i</span><span class="n">In</span> <span class="o">+</span> <span class="kt">i</span><span class="n">x</span>
  <span class="k">endif</span>
<span class="kd">endop</span>

<span class="kd">instr</span> <span class="nf">testUdoPerformance1</span>
  <span class="c1">; Here we test the performance gain of passing arrays by reference.</span>
  <span class="c1">; Passing the input array by reference seems to produce a speedup of ~25%,</span>
  <span class="kt">i</span><span class="n">num</span> <span class="o">=</span> <span class="mi">10000</span>
  <span class="kt">i</span><span class="n">Xs</span><span class="p">[]</span> <span class="nb">genarray</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">i</span><span class="n">num</span>
  <span class="kt">i</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kt">i</span><span class="n">t0</span> <span class="nb">rtclock</span>
  <span class="k">while</span> <span class="kt">i</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="k">do</span>
    <span class="kt">i</span><span class="n">Ys</span><span class="p">[]</span> <span class="nf">arrayadd</span> <span class="kt">i</span><span class="n">Xs</span><span class="p">,</span> <span class="mf">2.0</span>
    <span class="kt">i</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">od</span>
  <span class="kt">i</span><span class="n">t1</span> <span class="nb">rtclock</span>
  <span class="nb">prints</span> <span class="s">&quot;Dur UDO pass by value = </span><span class="si">%.8f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">i</span><span class="n">t1</span> <span class="o">-</span> <span class="kt">i</span><span class="n">t0</span>

  <span class="kt">i</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Xs</span><span class="p">)</span>
  <span class="kt">i</span><span class="n">t0</span> <span class="nb">rtclock</span>
  <span class="kt">i</span><span class="n">Y0</span><span class="p">[]</span> <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.1</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.2</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">Y0</span>   <span class="nf">arrayaddref</span> <span class="kt">i</span><span class="n">ref</span><span class="p">,</span> <span class="mf">0.3</span>
  <span class="kt">i</span><span class="n">t1</span> <span class="nb">rtclock</span>
  <span class="nb">prints</span> <span class="s">&quot;Dur UDO pass by ref input = </span><span class="si">%.8f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">i</span><span class="n">t1</span> <span class="o">-</span> <span class="kt">i</span><span class="n">t0</span>

  <span class="kt">i</span><span class="n">Zs</span><span class="p">[]</span> <span class="nb">genarray</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">i</span><span class="n">num</span>
  <span class="kt">i</span><span class="n">Out</span><span class="p">[]</span> <span class="nb">init</span> <span class="nb">lenarray</span><span class="p">(</span><span class="kt">i</span><span class="n">Zs</span><span class="p">)</span>

  <span class="kt">i</span><span class="n">t0</span> <span class="nb">rtclock</span>
  <span class="kt">i</span><span class="n">refZ</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Zs</span><span class="p">)</span>
  <span class="kt">i</span><span class="n">refOut</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Out</span><span class="p">)</span>  
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="kt">i</span><span class="n">refZ</span><span class="p">,</span> <span class="kt">i</span><span class="n">refOut</span><span class="p">,</span> <span class="mf">0.5</span>
  <span class="kt">i</span><span class="n">t1</span> <span class="nb">rtclock</span>

  <span class="nb">prints</span> <span class="s">&quot;Dur UDO pass by ref in and out=</span><span class="si">%.8f</span><span class="s"> </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="kt">i</span><span class="n">t1</span> <span class="o">-</span> <span class="kt">i</span><span class="n">t0</span>
  <span class="c1">; printarray iOut</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">7</span>
  <span class="kt">i</span><span class="n">In</span><span class="p">[]</span> <span class="nb">genarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span>
  <span class="kt">i</span><span class="n">Out</span><span class="p">[]</span> <span class="nb">init</span> <span class="nb">lenarray</span><span class="p">(</span><span class="kt">i</span><span class="n">In</span><span class="p">)</span>
  <span class="nf">arrayadd_byref_inout</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">In</span><span class="p">),</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Out</span><span class="p">),</span> <span class="mf">0.5</span>
  <span class="nb">turnoff</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">8</span>
  <span class="c1">; test k arrays</span>
  <span class="c1">; 1. A way to convert a i-array to a k-array by taking a reference</span>
  <span class="kt">i</span><span class="n">Xs</span><span class="p">[]</span> <span class="nb">genarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">99</span>
  <span class="kt">k</span><span class="n">Xs</span><span class="p">[]</span> <span class="n">deref</span> <span class="n">ref</span><span class="p">(</span><span class="kt">i</span><span class="n">Xs</span><span class="p">)</span>

  <span class="kt">k</span><span class="n">Xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">timeinsts</span><span class="p">()</span>
  <span class="nb">printarray</span> <span class="kt">k</span><span class="n">Xs</span><span class="p">,</span> <span class="nb">metro</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="kd">endin</span>

<span class="kd">instr</span> <span class="nf">9</span>
  <span class="c1">; we need genarray_i because otherwise kXs is not initialized at i-time</span>
  <span class="kt">k</span><span class="n">Xs</span><span class="p">[]</span> <span class="nb">genarray</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span>
  <span class="kt">i</span><span class="n">Xs</span><span class="p">[]</span> <span class="n">deref</span> <span class="n">ref</span><span class="p">(</span><span class="kt">k</span><span class="n">Xs</span><span class="p">)</span>
  <span class="kt">i</span><span class="n">Xs</span> <span class="o">+=</span> <span class="mi">10</span>
  <span class="nb">printarray</span> <span class="kt">i</span><span class="n">Xs</span>
  <span class="nb">printarray</span> <span class="kt">k</span><span class="n">Xs</span>
  <span class="nb">turnoff</span>
<span class="kd">endin</span>


<span class="c1">; schedule 1, 0, 1</span>
<span class="c1">; schedule 3, 0, 1</span>
<span class="c1">; schedule 5, 0, 0.1</span>
<span class="nb">schedule</span> <span class="s">&quot;testUdoPerformance1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span>
<span class="c1">; schedule 8, 0, 4</span>
<span class="o">&lt;/</span><span class="n">CsInstruments</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">CsScore</span><span class="o">&gt;</span>
<span class="n">e</span> <span class="mi">10</span> 

<span class="o">&lt;/</span><span class="n">CsScore</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">CsoundSynthesizer</span><span class="o">&gt;</span>
</code></pre></div>

<h2 id="see-also">See also</h2>
<ul>
<li><a href="deref.html">deref</a></li>
<li><a href="defer.html">defer</a></li>
<li><a href="http://www.csound.com/docs/manual/schedule.html">schedule</a></li>
<li><a href="http://www.csound.com/docs/manual/event.html">event</a></li>
<li><a href="http://www.csound.com/docs/manual/release.html">release</a></li>
</ul>
<h2 id="credits">Credits</h2>
<p>Eduardo Moguillansky, 2019</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="refvalid.html" class="btn btn-neutral float-right" title="refvalid">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="ramptrig.html" class="btn btn-neutral" title="ramptrig"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="ramptrig.html" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="refvalid.html" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
